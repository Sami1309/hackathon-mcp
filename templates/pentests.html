{% extends "base.html" %}

{% block title %}Pentests - NodeZero Security{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3">
                <i class="bi bi-search"></i>
                Penetration Tests
            </h1>
            <div>
                <button class="btn btn-success" onclick="refreshJobs()">
                    <i class="bi bi-arrow-clockwise"></i>
                    Refresh
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Active Jobs Summary -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">{{ jobs|length }}</h4>
                        <p class="card-text">Total Jobs</p>
                    </div>
                    <i class="bi bi-list-task fs-1"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card bg-warning text-dark">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">{{ running_jobs_count }}</h4>
                        <p class="card-text">Running</p>
                    </div>
                    <i class="bi bi-play-circle fs-1"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">{{ jobs|selectattr('status', 'equalto', 'Completed')|list|length }}</h4>
                        <p class="card-text">Completed</p>
                    </div>
                    <i class="bi bi-check-circle fs-1"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">{{ jobs|map(attribute='findings')|map('length')|sum }}</h4>
                        <p class="card-text">Total Findings</p>
                    </div>
                    <i class="bi bi-bug fs-1"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Pentest Jobs List -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-clipboard-data"></i>
                    Pentest Jobs
                </h5>
            </div>
            <div class="card-body p-0">
                {% if jobs %}
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-dark">
                            <tr>
                                <th>Job ID</th>
                                <th>Status</th>
                                <th>Progress</th>
                                <th>Targets</th>
                                <th>Scenarios</th>
                                <th>Start Time</th>
                                <th>Findings</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="jobsTableBody">
                            {% for job in jobs %}
                            <tr data-job-id="{{ job.id }}">
                                <td>
                                    <code>{{ job.id[:8] }}...</code>
                                </td>
                                <td>
                                    <span class="badge bg-{{ 'success' if job.status == 'Completed' else 'warning' if 'Running' in job.status else 'secondary' }} job-status">
                                        {{ job.status }}
                                    </span>
                                </td>
                                <td>
                                    <div class="progress" style="width: 100px;">
                                        <div class="progress-bar job-progress" role="progressbar"
                                             style="width: {{ job.progress }}%"
                                             aria-valuenow="{{ job.progress }}"
                                             aria-valuemin="0"
                                             aria-valuemax="100">
                                            {{ job.progress }}%
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <small>
                                        {% for target in job.targets %}
                                            <span class="badge bg-light text-dark">{{ target }}</span>
                                        {% endfor %}
                                    </small>
                                </td>
                                <td>
                                    <small class="text-muted">
                                        {{ job.scenarios|length }} scenarios
                                    </small>
                                </td>
                                <td>
                                    <small>{{ job.start_time.strftime('%Y-%m-%d %H:%M') }}</small>
                                </td>
                                <td>
                                    <span class="badge bg-{{ 'danger' if job.findings|length > 0 else 'secondary' }} findings-count">
                                        {{ job.findings|length }}
                                    </span>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-primary" onclick="viewLogs('{{ job.id }}')">
                                            <i class="bi bi-file-text"></i>
                                        </button>
                                        {% if job.status == 'Completed' and 'report_id' in job %}
                                        <button class="btn btn-outline-success" onclick="viewReport('{{ job.report_id }}')">
                                            <i class="bi bi-file-earmark-pdf"></i>
                                        </button>
                                        {% endif %}
                                        <button class="btn btn-outline-info" onclick="viewDetails('{{ job.id }}')">
                                            <i class="bi bi-info-circle"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="bi bi-inbox fs-1 text-muted"></i>
                    <p class="text-muted">No pentest jobs found.</p>
                    <a href="{{ url_for('vulnerabilities') }}" class="btn btn-primary">
                        Start by analyzing vulnerabilities
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Logs Modal -->
<div class="modal fade" id="logsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-file-text"></i>
                    Pentest Logs
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="logsContent" style="height: 400px; overflow-y: auto; background-color: #1a1a1a; color: #00ff00; font-family: 'Courier New', monospace; padding: 15px; border-radius: 5px;">
                    <!-- Logs will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="refreshLogs()">
                    <i class="bi bi-arrow-clockwise"></i>
                    Refresh Logs
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Job Details Modal -->
<div class="modal fade" id="detailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-info-circle"></i>
                    Job Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="detailsContent">
                <!-- Details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentJobId = null;
let autoRefreshInterval = null;

// Auto-refresh running jobs every 5 seconds
document.addEventListener('DOMContentLoaded', function() {
    autoRefreshInterval = setInterval(refreshRunningJobs, 5000);
});

// Clean up interval when page unloads
window.addEventListener('beforeunload', function() {
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
    }
});

async function refreshRunningJobs() {
    const rows = document.querySelectorAll('#jobsTableBody tr');

    for (const row of rows) {
        const jobId = row.getAttribute('data-job-id');
        const statusElement = row.querySelector('.job-status');

        if (statusElement && statusElement.textContent.includes('Running')) {
            try {
                const response = await fetch(`/pentest_status/${jobId}`);
                const status = await response.json();

                if (response.ok) {
                    // Update status
                    statusElement.textContent = status.status;
                    statusElement.className = `badge bg-${status.status === 'Completed' ? 'success' : 'warning'} job-status`;

                    // Update progress
                    const progressBar = row.querySelector('.job-progress');
                    if (progressBar) {
                        progressBar.style.width = `${status.progress}%`;
                        progressBar.textContent = `${status.progress}%`;
                        progressBar.setAttribute('aria-valuenow', status.progress);
                    }

                    // Update findings count
                    const findingsElement = row.querySelector('.findings-count');
                    if (findingsElement) {
                        findingsElement.textContent = status.findings_count;
                        findingsElement.className = `badge bg-${status.findings_count > 0 ? 'danger' : 'secondary'} findings-count`;
                    }

                    // Add report button if completed
                    if (status.status === 'Completed') {
                        const actionsCell = row.querySelector('td:last-child .btn-group');
                        if (actionsCell && !actionsCell.querySelector('.btn-outline-success')) {
                            const reportButton = document.createElement('button');
                            reportButton.className = 'btn btn-outline-success btn-sm';
                            reportButton.innerHTML = '<i class="bi bi-file-earmark-pdf"></i>';
                            reportButton.onclick = () => viewReport(jobId);
                            actionsCell.appendChild(reportButton);
                        }
                    }
                }
            } catch (error) {
                console.error('Error refreshing job status:', error);
            }
        }
    }
}

async function refreshJobs() {
    window.location.reload();
}

async function viewLogs(jobId) {
    currentJobId = jobId;

    try {
        const response = await fetch(`/pentest_logs/${jobId}`);
        const data = await response.json();

        if (response.ok) {
            const logsContent = document.getElementById('logsContent');
            logsContent.innerHTML = '';

            data.logs.forEach(log => {
                const logLine = document.createElement('div');
                logLine.innerHTML = `<span style="color: #888;">[${log.timestamp}]</span> <span style="color: ${getLogColor(log.level)};">${log.level}:</span> ${log.message}`;
                logsContent.appendChild(logLine);
            });

            // Scroll to bottom
            logsContent.scrollTop = logsContent.scrollHeight;

            new bootstrap.Modal(document.getElementById('logsModal')).show();
        } else {
            alert('Error loading logs: ' + data.error);
        }
    } catch (error) {
        alert('Failed to load logs: ' + error.message);
    }
}

function getLogColor(level) {
    switch (level) {
        case 'ERROR': return '#ff4444';
        case 'WARNING': return '#ffaa00';
        case 'SUCCESS': return '#00ff00';
        case 'INFO': return '#00aaff';
        default: return '#ffffff';
    }
}

async function refreshLogs() {
    if (currentJobId) {
        viewLogs(currentJobId);
    }
}

async function viewDetails(jobId) {
    try {
        const response = await fetch(`/pentest_status/${jobId}`);
        const job = await response.json();

        if (response.ok) {
            const detailsContent = document.getElementById('detailsContent');
            detailsContent.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Job Information</h6>
                        <table class="table table-sm">
                            <tr>
                                <td><strong>Job ID:</strong></td>
                                <td><code>${job.id}</code></td>
                            </tr>
                            <tr>
                                <td><strong>Status:</strong></td>
                                <td><span class="badge bg-${job.status === 'Completed' ? 'success' : 'warning'}">${job.status}</span></td>
                            </tr>
                            <tr>
                                <td><strong>Progress:</strong></td>
                                <td>${job.progress}%</td>
                            </tr>
                            <tr>
                                <td><strong>Findings:</strong></td>
                                <td><span class="badge bg-${job.findings_count > 0 ? 'danger' : 'secondary'}">${job.findings_count}</span></td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>Statistics</h6>
                        <table class="table table-sm">
                            <tr>
                                <td><strong>Log Entries:</strong></td>
                                <td>${job.logs_count}</td>
                            </tr>
                        </table>
                    </div>
                </div>
            `;

            new bootstrap.Modal(document.getElementById('detailsModal')).show();
        } else {
            alert('Error loading job details: ' + job.error);
        }
    } catch (error) {
        alert('Failed to load job details: ' + error.message);
    }
}

function viewReport(reportId) {
    window.open(`/report/${reportId}`, '_blank');
}
</script>
{% endblock %}