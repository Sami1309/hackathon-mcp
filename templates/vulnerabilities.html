{% extends "base.html" %}

{% block title %}Vulnerabilities - NodeZero Security{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3">
                <i class="bi bi-bug"></i>
                Vulnerability Management
            </h1>
            <div>
                <button class="btn btn-primary" onclick="analyzeSelected()">
                    <i class="bi bi-cpu"></i>
                    Analyze Selected with Claude
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Filters -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <label class="form-label">Severity</label>
                        <select class="form-select" id="severityFilter" onchange="filterTable()">
                            <option value="">All Severities</option>
                            <option value="Critical">Critical</option>
                            <option value="High">High</option>
                            <option value="Medium">Medium</option>
                            <option value="Low">Low</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Status</label>
                        <select class="form-select" id="statusFilter" onchange="filterTable()">
                            <option value="">All Statuses</option>
                            <option value="Open">Open</option>
                            <option value="In Progress">In Progress</option>
                            <option value="In Review">In Review</option>
                            <option value="Resolved">Resolved</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Category</label>
                        <select class="form-select" id="categoryFilter" onchange="filterTable()">
                            <option value="">All Categories</option>
                            <option value="Web Application">Web Application</option>
                            <option value="Network Security">Network Security</option>
                            <option value="Authentication">Authentication</option>
                            <option value="Data Security">Data Security</option>
                            <option value="Encryption">Encryption</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Search</label>
                        <input type="text" class="form-control" id="searchFilter" placeholder="Search vulnerabilities..." onkeyup="filterTable()">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Vulnerabilities Table -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    Vulnerabilities
                    <span class="badge bg-secondary" id="totalCount">{{ vulnerabilities|length }}</span>
                </h5>
                <div>
                    <button class="btn btn-sm btn-outline-primary" onclick="selectAll()">Select All</button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="selectNone()">Select None</button>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0" id="vulnerabilitiesTable">
                        <thead class="table-dark">
                            <tr>
                                <th width="50">
                                    <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()">
                                </th>
                                <th>Severity</th>
                                <th>Title</th>
                                <th>CVE</th>
                                <th>CVSS</th>
                                <th>Category</th>
                                <th>Affected Systems</th>
                                <th>Status</th>
                                <th>Source</th>
                                <th>Discovery Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for vuln in vulnerabilities %}
                            <tr data-vuln-id="{{ vuln.id }}" data-severity="{{ vuln.severity }}" data-status="{{ vuln.status }}" data-category="{{ vuln.category }}">
                                <td>
                                    <input type="checkbox" class="vuln-checkbox" value="{{ vuln.id }}">
                                </td>
                                <td>
                                    <span class="badge bg-{{ 'danger' if vuln.severity == 'Critical' else 'warning' if vuln.severity == 'High' else 'info' if vuln.severity == 'Medium' else 'secondary' }}">
                                        {{ vuln.severity }}
                                    </span>
                                </td>
                                <td>
                                    <strong>{{ vuln.title[:40] }}{{ '...' if vuln.title|length > 40 else '' }}</strong>
                                    <br>
                                    <small class="text-muted">{{ vuln.description[:60] }}{{ '...' if vuln.description|length > 60 else '' }}</small>
                                </td>
                                <td>
                                    {% if vuln.cve_id %}
                                        <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name={{ vuln.cve_id }}" target="_blank" class="text-decoration-none">
                                            {{ vuln.cve_id }}
                                            <i class="bi bi-box-arrow-up-right"></i>
                                        </a>
                                    {% else %}
                                        <span class="text-muted">N/A</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge bg-{{ 'danger' if vuln.cvss_score >= 9.0 else 'warning' if vuln.cvss_score >= 7.0 else 'info' if vuln.cvss_score >= 4.0 else 'secondary' }}">
                                        {{ vuln.cvss_score }}
                                    </span>
                                </td>
                                <td>{{ vuln.category }}</td>
                                <td>
                                    <small>
                                        {% for system in vuln.affected_systems %}
                                            <span class="badge bg-light text-dark">{{ system }}</span>
                                        {% endfor %}
                                    </small>
                                </td>
                                <td>
                                    <span class="badge bg-{{ 'success' if vuln.status == 'Resolved' else 'warning' if vuln.status == 'In Progress' else 'primary' if vuln.status == 'In Review' else 'danger' }}">
                                        {{ vuln.status }}
                                    </span>
                                </td>
                                <td>
                                    <small class="text-muted">{{ vuln.source[:20] }}{{ '...' if vuln.source|length > 20 else '' }}</small>
                                </td>
                                <td>{{ vuln.discovery_date }}</td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-primary btn-sm" onclick="viewDetails('{{ vuln.id }}')">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                        <button class="btn btn-outline-warning btn-sm" onclick="editVuln('{{ vuln.id }}')">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function filterTable() {
    const severityFilter = document.getElementById('severityFilter').value;
    const statusFilter = document.getElementById('statusFilter').value;
    const categoryFilter = document.getElementById('categoryFilter').value;
    const searchFilter = document.getElementById('searchFilter').value.toLowerCase();

    const table = document.getElementById('vulnerabilitiesTable');
    const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
    let visibleCount = 0;

    for (let i = 0; i < rows.length; i++) {
        const row = rows[i];
        const severity = row.getAttribute('data-severity');
        const status = row.getAttribute('data-status');
        const category = row.getAttribute('data-category');
        const text = row.textContent.toLowerCase();

        let show = true;

        if (severityFilter && severity !== severityFilter) show = false;
        if (statusFilter && status !== statusFilter) show = false;
        if (categoryFilter && category !== categoryFilter) show = false;
        if (searchFilter && !text.includes(searchFilter)) show = false;

        row.style.display = show ? '' : 'none';
        if (show) visibleCount++;
    }

    document.getElementById('totalCount').textContent = visibleCount;
}

function selectAll() {
    const checkboxes = document.querySelectorAll('.vuln-checkbox');
    checkboxes.forEach(cb => {
        if (cb.closest('tr').style.display !== 'none') {
            cb.checked = true;
        }
    });
    updateSelectAllCheckbox();
}

function selectNone() {
    const checkboxes = document.querySelectorAll('.vuln-checkbox');
    checkboxes.forEach(cb => cb.checked = false);
    document.getElementById('selectAllCheckbox').checked = false;
}

function toggleSelectAll() {
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    const checkboxes = document.querySelectorAll('.vuln-checkbox');

    checkboxes.forEach(cb => {
        if (cb.closest('tr').style.display !== 'none') {
            cb.checked = selectAllCheckbox.checked;
        }
    });
}

function updateSelectAllCheckbox() {
    const checkboxes = Array.from(document.querySelectorAll('.vuln-checkbox'));
    const visibleCheckboxes = checkboxes.filter(cb => cb.closest('tr').style.display !== 'none');
    const checkedVisible = visibleCheckboxes.filter(cb => cb.checked);

    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    selectAllCheckbox.checked = visibleCheckboxes.length > 0 && checkedVisible.length === visibleCheckboxes.length;
    selectAllCheckbox.indeterminate = checkedVisible.length > 0 && checkedVisible.length < visibleCheckboxes.length;
}

// Update select all checkbox when individual checkboxes change
document.addEventListener('change', function(e) {
    if (e.target.classList.contains('vuln-checkbox')) {
        updateSelectAllCheckbox();
    }
});

async function analyzeSelected() {
    const selectedIds = Array.from(document.querySelectorAll('.vuln-checkbox:checked')).map(cb => cb.value);

    if (selectedIds.length === 0) {
        alert('Please select vulnerabilities to analyze.');
        return;
    }

    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="bi bi-hourglass-split"></i> Analyzing...';
    button.disabled = true;

    try {
        const response = await fetch('/analyze_vulnerabilities', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                vulnerability_ids: selectedIds
            })
        });

        const analysis = await response.json();

        if (response.ok) {
            showAnalysisModal(analysis);
        } else {
            alert('Error: ' + analysis.error);
        }
    } catch (error) {
        alert('Failed to analyze vulnerabilities: ' + error.message);
    } finally {
        button.innerHTML = originalText;
        button.disabled = false;
    }
}

function showAnalysisModal(analysis) {
    const modalHtml = `
        <div class="modal fade" id="analysisModal" tabindex="-1">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="bi bi-cpu"></i>
                            Claude AI Vulnerability Analysis
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6><i class="bi bi-file-text"></i> Analysis Summary</h6>
                                <div class="alert alert-info">
                                    ${analysis.summary}
                                </div>

                                <h6><i class="bi bi-exclamation-triangle"></i> Priority Assessment</h6>
                                <p>
                                    <span class="badge bg-warning fs-6">${analysis.priority_assessment}</span>
                                </p>
                            </div>
                            <div class="col-md-6">
                                <h6><i class="bi bi-bullseye"></i> Recommended Targets</h6>
                                <div class="list-group mb-3">
                                    ${analysis.recommended_targets.map(target => `
                                        <div class="list-group-item">
                                            <i class="bi bi-server"></i> ${target}
                                        </div>
                                    `).join('')}
                                </div>

                                <h6><i class="bi bi-list-check"></i> Test Scenarios</h6>
                                <div class="list-group">
                                    ${analysis.test_scenarios.map(scenario => `
                                        <div class="list-group-item">
                                            <i class="bi bi-check-circle"></i> ${scenario}
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="bi bi-x"></i> Close
                        </button>
                        <button type="button" class="btn btn-primary" onclick="startPentestFromAnalysis()">
                            <i class="bi bi-play-circle"></i> Start NodeZero Pentest
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;

    document.body.insertAdjacentHTML('beforeend', modalHtml);
    const modal = new bootstrap.Modal(document.getElementById('analysisModal'));

    // Store analysis data on the modal for later use
    document.getElementById('analysisModal').analysisData = analysis;

    modal.show();

    // Clean up modal when closed
    document.getElementById('analysisModal').addEventListener('hidden.bs.modal', function() {
        this.remove();
    });
}

async function startPentestFromAnalysis() {
    const modal = document.getElementById('analysisModal');
    const analysis = modal.analysisData;

    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="bi bi-hourglass-split"></i> Starting...';
    button.disabled = true;

    try {
        const response = await fetch('/start_pentest', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                targets: analysis.recommended_targets,
                scenarios: analysis.test_scenarios
            })
        });

        const result = await response.json();

        if (response.ok) {
            bootstrap.Modal.getInstance(modal).hide();
            alert(`NodeZero pentest started successfully!\nJob ID: ${result.job_id}`);
            window.location.href = '/pentests';
        } else {
            alert('Error: ' + result.error);
        }
    } catch (error) {
        alert('Failed to start pentest: ' + error.message);
    } finally {
        button.innerHTML = originalText;
        button.disabled = false;
    }
}

function viewDetails(vulnId) {
    alert(`View details for vulnerability: ${vulnId}`);
    // Implement detailed view modal
}

function editVuln(vulnId) {
    alert(`Edit vulnerability: ${vulnId}`);
    // Implement edit functionality
}
</script>
{% endblock %}