{% extends "base.html" %}

{% block title %}{{ report.title }} - NodeZero Security{% endblock %}

{% block extra_css %}
<style>
    .report-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem 0;
        margin: -1.5rem -15px 2rem -15px;
    }

    .finding-card {
        border-left: 4px solid;
        margin-bottom: 1rem;
    }

    .finding-critical {
        border-left-color: #dc3545;
    }

    .finding-high {
        border-left-color: #fd7e14;
    }

    .finding-medium {
        border-left-color: #ffc107;
    }

    .finding-low {
        border-left-color: #28a745;
    }

    .risk-matrix {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 1rem;
    }

    @media print {
        .report-header {
            background: #333 !important;
            -webkit-print-color-adjust: exact;
        }

        .no-print {
            display: none !important;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Report Header -->
<div class="report-header">
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-8">
                <h1 class="display-6 mb-3">{{ report.title }}</h1>
                <p class="lead mb-0">
                    <i class="bi bi-calendar3"></i>
                    Generated: {{ report.generation_time[:19]|replace('T', ' ') }}
                </p>
            </div>
            <div class="col-md-4 text-end">
                <div class="no-print">
                    <button class="btn btn-light btn-lg me-2" onclick="window.print()">
                        <i class="bi bi-printer"></i>
                        Print Report
                    </button>
                    <button class="btn btn-outline-light btn-lg" onclick="exportPDF()">
                        <i class="bi bi-file-pdf"></i>
                        Export PDF
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Executive Summary -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title mb-0">
                    <i class="bi bi-file-text"></i>
                    Executive Summary
                </h3>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <p class="lead">{{ report.executive_summary.overview }}</p>

                        <h5>Key Recommendations</h5>
                        <ul class="list-group list-group-flush">
                            {% for recommendation in report.executive_summary.recommendations %}
                            <li class="list-group-item d-flex align-items-start">
                                <i class="bi bi-check-circle-fill text-success me-2 mt-1"></i>
                                {{ recommendation }}
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                    <div class="col-md-4">
                        <div class="risk-matrix">
                            <h6 class="mb-3">
                                <i class="bi bi-exclamation-triangle"></i>
                                Risk Assessment
                            </h6>

                            <div class="text-center mb-3">
                                <span class="badge bg-{{ 'danger' if report.executive_summary.risk_level == 'High' else 'warning' if report.executive_summary.risk_level == 'Medium' else 'success' }} fs-4">
                                    {{ report.executive_summary.risk_level }} Risk
                                </span>
                            </div>

                            <h6>Vulnerability Distribution</h6>
                            <div class="row text-center">
                                {% for severity, count in report.technical_details.risk_distribution.items() %}
                                <div class="col-6 mb-2">
                                    <div class="bg-{{ 'danger' if severity == 'Critical' else 'warning' if severity == 'High' else 'info' if severity == 'Medium' else 'secondary' }} text-white rounded p-2">
                                        <h6 class="mb-0">{{ count }}</h6>
                                        <small>{{ severity }}</small>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Methodology -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h4 class="card-title mb-0">
                    <i class="bi bi-gear"></i>
                    Methodology
                </h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <h6>Scope</h6>
                        <ul class="list-unstyled">
                            {% for target in report.methodology.scope %}
                            <li>
                                <i class="bi bi-server text-primary"></i>
                                <code>{{ target }}</code>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                    <div class="col-md-3">
                        <h6>Duration</h6>
                        <p class="mb-0">
                            <i class="bi bi-clock"></i>
                            {{ report.methodology.duration }}
                        </p>
                    </div>
                    <div class="col-md-3">
                        <h6>Approach</h6>
                        <p class="mb-0">{{ report.methodology.approach }}</p>
                    </div>
                    <div class="col-md-3">
                        <h6>Tools Used</h6>
                        <ul class="list-unstyled">
                            {% for tool in report.methodology.tools %}
                            <li>
                                <i class="bi bi-wrench text-muted"></i>
                                {{ tool }}
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Technical Details -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h4 class="card-title mb-0">
                    <i class="bi bi-graph-up"></i>
                    Technical Summary
                </h4>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-3">
                        <div class="border rounded p-3">
                            <h3 class="text-primary mb-1">{{ report.technical_details.total_hosts_tested }}</h3>
                            <p class="text-muted mb-0">Hosts Tested</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="border rounded p-3">
                            <h3 class="text-warning mb-1">{{ report.technical_details.vulnerabilities_found }}</h3>
                            <p class="text-muted mb-0">Vulnerabilities Found</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="border rounded p-3">
                            <h3 class="text-danger mb-1">{{ report.technical_details.exploitable_vulnerabilities }}</h3>
                            <p class="text-muted mb-0">Exploitable</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="border rounded p-3">
                            <h3 class="text-success mb-1">{{ ((report.technical_details.total_hosts_tested - report.technical_details.vulnerabilities_found) / report.technical_details.total_hosts_tested * 100)|round(1) }}%</h3>
                            <p class="text-muted mb-0">Secure Hosts</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Detailed Findings -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h4 class="card-title mb-0">
                    <i class="bi bi-bug"></i>
                    Detailed Findings
                </h4>
            </div>
            <div class="card-body">
                {% if report.findings %}
                    {% for finding in report.findings %}
                    <div class="finding-card finding-{{ finding.severity.lower() }} card">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-8">
                                    <h5 class="card-title d-flex align-items-center">
                                        {{ finding.title }}
                                        <span class="badge bg-{{ 'danger' if finding.severity == 'Critical' else 'warning' if finding.severity == 'High' else 'info' if finding.severity == 'Medium' else 'secondary' }} ms-2">
                                            {{ finding.severity }}
                                        </span>
                                    </h5>
                                    <p class="card-text">{{ finding.description }}</p>

                                    {% if 'exploit_method' in finding %}
                                    <h6>Exploitation Method</h6>
                                    <p class="text-muted">{{ finding.exploit_method }}</p>
                                    {% endif %}

                                    <div class="mt-3">
                                        <h6>Affected Host</h6>
                                        <code>{{ finding.affected_host }}</code>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="border rounded p-3 bg-light">
                                        <h6 class="text-center mb-3">Risk Metrics</h6>

                                        <div class="text-center mb-3">
                                            <div class="display-6 text-{{ 'danger' if finding.cvss_score >= 9.0 else 'warning' if finding.cvss_score >= 7.0 else 'info' if finding.cvss_score >= 4.0 else 'secondary' }}">
                                                {{ finding.cvss_score }}
                                            </div>
                                            <small class="text-muted">CVSS Score</small>
                                        </div>

                                        <div class="row text-center">
                                            <div class="col-6">
                                                <strong>Impact</strong><br>
                                                <span class="badge bg-{{ 'danger' if finding.severity == 'Critical' else 'warning' if finding.severity == 'High' else 'info' if finding.severity == 'Medium' else 'secondary' }}">
                                                    {{ finding.severity }}
                                                </span>
                                            </div>
                                            <div class="col-6">
                                                <strong>Likelihood</strong><br>
                                                <span class="badge bg-{{ 'danger' if finding.cvss_score >= 7.0 else 'warning' }}">
                                                    {{ 'High' if finding.cvss_score >= 7.0 else 'Medium' }}
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center py-5">
                        <i class="bi bi-shield-check fs-1 text-success"></i>
                        <h4 class="text-success">No Critical Findings</h4>
                        <p class="text-muted">No exploitable vulnerabilities were discovered during this assessment.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Execution Logs (Collapsible) -->
<div class="row mb-4 no-print">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h4 class="card-title mb-0">
                    <button class="btn btn-link p-0 text-decoration-none" type="button" data-bs-toggle="collapse" data-bs-target="#executionLogs">
                        <i class="bi bi-chevron-right" id="logsChevron"></i>
                        Execution Logs
                    </button>
                </h4>
            </div>
            <div class="collapse" id="executionLogs">
                <div class="card-body">
                    <div style="max-height: 400px; overflow-y: auto; background-color: #1a1a1a; color: #00ff00; font-family: 'Courier New', monospace; padding: 15px; border-radius: 5px;">
                        {% for log in report.logs %}
                        <div class="mb-1">
                            <span style="color: #888;">[{{ log.timestamp }}]</span>
                            <span style="color: {{ '#ff4444' if log.level == 'ERROR' else '#ffaa00' if log.level == 'WARNING' else '#00ff00' if log.level == 'SUCCESS' else '#00aaff' if log.level == 'INFO' else '#ffffff' }};">{{ log.level }}:</span>
                            {{ log.message }}
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Footer -->
<div class="row">
    <div class="col-12">
        <div class="card bg-dark text-light">
            <div class="card-body text-center">
                <p class="mb-2">
                    <strong>NodeZero Penetration Testing Report</strong>
                </p>
                <p class="small mb-0">
                    Generated by NodeZero MCP Server via Claude AI • {{ report.generation_time[:10] }} •
                    <a href="#" class="text-light">Contact Security Team</a>
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Toggle chevron icon when collapsing logs
document.getElementById('executionLogs').addEventListener('shown.bs.collapse', function() {
    document.getElementById('logsChevron').className = 'bi bi-chevron-down';
});

document.getElementById('executionLogs').addEventListener('hidden.bs.collapse', function() {
    document.getElementById('logsChevron').className = 'bi bi-chevron-right';
});

function exportPDF() {
    // Hide no-print elements temporarily
    const noPrintElements = document.querySelectorAll('.no-print');
    noPrintElements.forEach(el => el.style.display = 'none');

    // Trigger print dialog
    window.print();

    // Restore no-print elements after a short delay
    setTimeout(() => {
        noPrintElements.forEach(el => el.style.display = '');
    }, 100);
}

// Auto-scroll to findings if there are any
document.addEventListener('DOMContentLoaded', function() {
    const findings = document.querySelectorAll('.finding-card');
    if (findings.length > 0 && window.location.hash === '#findings') {
        findings[0].scrollIntoView({ behavior: 'smooth' });
    }
});

// Add smooth scrolling for internal links
document.querySelectorAll('a[href^="#"]').forEach(anchor => {
    anchor.addEventListener('click', function(e) {
        e.preventDefault();
        const target = document.querySelector(this.getAttribute('href'));
        if (target) {
            target.scrollIntoView({ behavior: 'smooth' });
        }
    });
});
</script>
{% endblock %}